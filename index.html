<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Registro Informe Mensual</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Reset & Variables --- */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        :root {
            --primary: #000000;
            --surface: #ffffff;
            --surface-variant: #f2f2f7;
            --border: #e5e5ea;
            --text-main: #000000;
            --text-secondary: #86868b;
            --error: #ff3b30;
            --success: #34c759;
            --radius-lg: 16px;
            --anim-speed: 0.4s;
            --anim-curve: cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--surface);
            color: var(--text-main);
            height: 100vh; height: 100dvh; overflow: hidden; overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
        }
        /* --- Estructura --- */
        .app-container { height: 100%; display: flex; flex-direction: column; max-width: 600px; margin: 0 auto; background: var(--surface); }
        .app-header { padding-top: env(safe-area-inset-top); background: var(--surface); flex-shrink: 0; z-index: 10; }
        .header-content { padding: 20px 24px 10px; }
        .header-content h1 { font-family: 'Playfair Display', serif; font-size: 1.75rem; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 4px; }
        .header-content p { color: var(--text-secondary); font-size: 0.9rem; }
        
        /* --- Stepper --- */
        .step-indicator { display: flex; justify-content: space-between; padding: 10px 24px 20px; position: relative; }
        .step-indicator::before { content: ''; position: absolute; top: 25px; left: 40px; right: 40px; height: 2px; background-color: var(--surface-variant); z-index: 0; }
        .progress-line { position: absolute; top: 25px; left: 40px; height: 2px; background-color: var(--primary); z-index: 1; width: 0%; transition: width 0.4s ease; }
        .step { display: flex; flex-direction: column; align-items: center; position: relative; z-index: 2; width: 40px; }
        .step-icon { width: 32px; height: 32px; border-radius: 50%; background-color: var(--surface); border: 2px solid var(--surface-variant); color: var(--text-secondary); display: flex; justify-content: center; align-items: center; font-size: 0.8rem; font-weight: 600; transition: all 0.3s var(--anim-curve); margin-bottom: 6px; }
        .step.active .step-icon { border-color: var(--primary); background-color: var(--primary); color: white; transform: scale(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .step.completed .step-icon { background-color: var(--primary); border-color: var(--primary); color: white; }
        .step-label { font-size: 0.7rem; font-weight: 500; color: var(--text-secondary); opacity: 0; transform: translateY(-5px); transition: all 0.3s ease; position: absolute; bottom: -15px; white-space: nowrap; }
        .step.active .step-label { opacity: 1; transform: translateY(0); color: var(--primary); }

        /* --- Contenido --- */
        .app-content { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 0 24px; position: relative; scrollbar-width: none; }
        .app-content::-webkit-scrollbar { display: none; }
        .step-card { display: none; padding-top: 10px; padding-bottom: 40px; min-height: 100%; }
        .step-card.active { display: block; animation: fadeInSlideUp var(--anim-speed) var(--anim-curve) forwards; }
        @keyframes fadeInSlideUp { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }

        .card-title { font-family: 'Playfair Display', serif; font-size: 2rem; margin-bottom: 30px; color: var(--text-main); line-height: 1.2; }
        .form-group { margin-bottom: 24px; }
        label { display: block; margin-bottom: 10px; font-size: 0.95rem; font-weight: 600; color: var(--text-main); }
        .required::after { content: '*'; color: var(--error); margin-left: 4px; }
        
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 18px 20px; border: 1px solid transparent; border-radius: var(--radius-lg); background-color: var(--surface-variant); font-family: 'Inter', sans-serif; font-size: 1rem; color: var(--text-main); transition: all 0.2s ease; -webkit-appearance: none; }
        input:focus, select:focus, textarea:focus { background-color: var(--surface); border-color: var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.08); transform: translateY(-1px); }
        
        /* --- Radio Tiles --- */
        .radio-group { display: flex; flex-direction: column; gap: 12px; }
        .radio-option { position: relative; display: flex; align-items: center; padding: 18px 20px; border-radius: var(--radius-lg); background-color: var(--surface-variant); border: 1px solid transparent; cursor: pointer; transition: all 0.2s var(--anim-curve); overflow: hidden; }
        .radio-option.selected { background-color: var(--primary); color: white; box-shadow: 0 8px 16px rgba(0,0,0,0.15); transform: scale(1.02); }
        .radio-option input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; left: 0; top: 0; }
        .radio-option label { margin: 0; font-weight: 500; z-index: 1; pointer-events: none; display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .radio-option::after { content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; right: 20px; opacity: 0; transform: scale(0.5); transition: all 0.2s ease; }
        .radio-option.selected::after { opacity: 1; transform: scale(1); color: white; }

        .error-message { color: var(--error); font-size: 0.8rem; margin-top: 8px; padding-left: 4px; display: none; animation: shake 0.4s ease; font-weight: 500; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }

        /* --- Resumen --- */
        .summary { background-color: var(--surface-variant); border-radius: var(--radius-lg); padding: 8px 0; }
        .summary-item { display: flex; justify-content: space-between; padding: 16px 24px; border-bottom: 1px solid rgba(0,0,0,0.05); align-items: center; }
        .summary-item:last-child { border-bottom: none; }
        .summary-label { color: var(--text-secondary); font-size: 0.9rem; }
        .summary-value { font-weight: 600; text-align: right; font-size: 0.95rem; }

        /* --- Footer --- */
        .app-footer { padding: 20px 24px; padding-bottom: max(20px, env(safe-area-inset-bottom)); background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); display: flex; gap: 16px; flex-shrink: 0; z-index: 20; }
        .btn { height: 56px; border: none; border-radius: var(--radius-lg); font-family: 'Inter', sans-serif; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.2s; display: flex; justify-content: center; align-items: center; }
        .btn-prev { width: 56px; background-color: var(--surface-variant); color: var(--text-main); flex-shrink: 0; }
        .btn-next, .btn-submit { flex: 1; background-color: var(--primary); color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:active { transform: scale(0.96); }

        .hours-container { display: none; }
        .hours-container.active { display: block; animation: fadeInSlideUp 0.3s ease; }
        .optional { font-weight: 400; color: var(--text-secondary); font-size: 0.8rem; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 1000; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-card { background: var(--surface); padding: 32px 24px; border-radius: 24px; width: 85%; max-width: 320px; text-align: center; transform: scale(0.85); opacity: 0; transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .modal-overlay.active .modal-card { transform: scale(1); opacity: 1; }
        .modal-icon-container { width: 70px; height: 70px; background-color: rgba(52, 199, 89, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .modal-icon { font-size: 2.2rem; color: var(--success); }
        .modal-card h3 { font-family: 'Playfair Display', serif; font-size: 1.5rem; margin-bottom: 8px; color: var(--text-main); }
        .modal-card p { color: var(--text-secondary); margin-bottom: 24px; font-size: 0.95rem; line-height: 1.5; }
        .btn-modal { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: var(--radius-lg); font-weight: 600; font-size: 1rem; cursor: pointer; transition: transform 0.2s; }
        .btn-modal:active { transform: scale(0.96); }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <h1>Informe Mensual</h1>
                <p>Complete su reporte de actividad</p>
            </div>
            <div class="step-indicator">
                <div class="progress-line" id="progress-line"></div>
                <div class="step active" id="step1-indicator"><div class="step-icon">1</div><span class="step-label">Datos</span></div>
                <div class="step" id="step2-indicator"><div class="step-icon">2</div><span class="step-label">Actividad</span></div>
                <div class="step" id="step3-indicator"><div class="step-icon">3</div><span class="step-label">Tipo</span></div>
                <div class="step" id="step4-indicator"><div class="step-icon">4</div><span class="step-label">Extras</span></div>
                <div class="step" id="step5-indicator"><div class="step-icon"><i class="fas fa-check"></i></div><span class="step-label">Fin</span></div>
            </div>
        </header>
        
        <main class="app-content">
            <div class="step-card active" id="step1">
                <h2 class="card-title">Datos Personales</h2>
                <div class="form-group">
                    <label for="nombre" class="required">Nombre</label>
                    <input type="text" id="nombre" placeholder="Ej. Juan">
                    <div class="error-message" id="nombre-error">Por favor ingrese su nombre</div>
                </div>
                <div class="form-group">
                    <label for="apellido" class="required">Apellido</label>
                    <input type="text" id="apellido" placeholder="Ej. Pérez">
                    <div class="error-message" id="apellido-error">Por favor ingrese su apellido</div>
                </div>
            </div>
            
            <div class="step-card" id="step2">
                <h2 class="card-title">Actividad</h2>
                <div class="form-group">
                    <label class="required">¿Predicó durante el mes?</label>
                    <div class="radio-group">
                        <div class="radio-option" id="opt-si">
                            <input type="radio" id="predico-si" name="predico" value="Sí" onchange="updateRadioVisuals(this)">
                            <label for="predico-si">Sí, participé</label>
                        </div>
                        <div class="radio-option" id="opt-no">
                            <input type="radio" id="predico-no" name="predico" value="No" onchange="updateRadioVisuals(this)">
                            <label for="predico-no">No participé</label>
                        </div>
                    </div>
                    <div class="error-message" id="predico-error">Seleccione una opción</div>
                </div>
            </div>
            
            <div class="step-card" id="step3">
                <h2 class="card-title">Detalles</h2>
                <div class="form-group">
                    <label for="tipo" class="required">Tipo de publicador</label>
                    <select id="tipo">
                        <option value="" disabled selected>Seleccione...</option>
                        <option value="Publicador">Publicador</option>
                        <option value="Precursor Regular">Precursor Regular</option>
                        <option value="Precursor Auxiliar">Precursor Auxiliar</option>
                    </select>
                    <div class="error-message" id="tipo-error">Seleccione su tipo</div>
                </div>
                
                <div class="hours-container" id="hours-container">
                    <div class="form-group">
                        <label for="horas" class="required">Horas realizadas</label>
                        <input type="number" id="horas" inputmode="numeric" placeholder="0">
                        <div class="error-message" id="horas-error">Ingrese las horas</div>
                    </div>
                </div>
            </div>
            
            <div class="step-card" id="step4">
                <h2 class="card-title">Adicional</h2>
                <div class="form-group">
                    <label for="estudio">Estudios Bíblicos <span class="optional">(Opcional)</span></label>
                    <input type="number" id="estudio" inputmode="numeric" placeholder="Cantidad">
                </div>
                <div class="form-group">
                    <label for="observaciones">Notas <span class="optional">(Opcional)</span></label>
                    <textarea id="observaciones" rows="4" placeholder="Comentarios adicionales..."></textarea>
                </div>
            </div>
            
            <div class="step-card" id="step5">
                <h2 class="card-title">Confirmar</h2>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">Verifique que los datos sean correctos.</p>
                <div class="summary">
                    <div class="summary-item">
                        <span class="summary-label">Nombre</span>
                        <span class="summary-value" id="resumen-nombre"></span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Predicación</span>
                        <span class="summary-value" id="resumen-predico"></span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Tipo</span>
                        <span class="summary-value" id="resumen-tipo"></span>
                    </div>
                    <div class="summary-item" id="resumen-horas-container">
                        <span class="summary-label">Horas</span>
                        <span class="summary-value" id="resumen-horas"></span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Estudios</span>
                        <span class="summary-value" id="resumen-estudio"></span>
                    </div>
                    <div class="summary-item" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                        <span class="summary-label">Observaciones</span>
                        <span class="summary-value" id="resumen-observaciones" style="text-align: left; font-weight: 400; color: var(--text-main);"></span>
                    </div>
                </div>
            </div>
        </main>
        
        <footer class="app-footer">
            <button class="btn btn-prev" id="prev-btn" style="display: none;"><i class="fas fa-arrow-left"></i></button>
            <button class="btn btn-next" id="next-btn">Siguiente</button>
            <button class="btn btn-submit" id="submit-btn" style="display: none;">Enviar Reporte</button>
        </footer>
    </div>

    <div class="modal-overlay" id="success-modal">
        <div class="modal-card">
            <div class="modal-icon-container"><i class="fas fa-check modal-icon"></i></div>
            <h3>¡Enviado!</h3>
            <p>Su informe se ha registrado correctamente en el sistema.</p>
            <button class="btn-modal" id="modal-close-btn">Aceptar</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://bitdiyawwvmatxuckaob.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJpdGRpeWF3d3ZtYXR4dWNrYW9iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1NjIwNTksImV4cCI6MjA4MzEzODA1OX0.kdGxKiQ5INhJAB7ZSwxcy5e8z1XZ73M02IEzHZgEdW0';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentStep = 1;
        const totalSteps = 5;
        
        const stepCards = document.querySelectorAll('.step-card');
        const stepIndicators = document.querySelectorAll('.step');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');
        const progressLine = document.getElementById('progress-line');
        const successModal = document.getElementById('success-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        
        function updateRadioVisuals(input) {
            document.querySelectorAll('.radio-option').forEach(el => el.classList.remove('selected'));
            if(input.checked) input.parentElement.classList.add('selected');
        }

        function updateProgress() {
            const percentage = ((currentStep - 1) / (totalSteps - 1)) * 100;
            progressLine.style.width = `${percentage}%`;
        }

        function updateNavigationButtons() {
            prevBtn.style.display = (currentStep === 1) ? 'none' : 'flex';
            
            if (currentStep === totalSteps) {
                nextBtn.style.display = 'none';
                submitBtn.style.display = 'block';
            } else {
                nextBtn.style.display = 'block';
                submitBtn.style.display = 'none';
            }
            nextBtn.textContent = (currentStep === totalSteps - 1) ? 'Ver Resumen' : 'Siguiente';
            updateProgress();
        }
        
        function goToStep(step) {
            if (step > currentStep && !validateStep(currentStep)) {
                nextBtn.style.animation = 'shake 0.4s ease';
                setTimeout(() => nextBtn.style.animation = '', 400);
                return;
            }
            stepCards.forEach(card => card.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            
            stepIndicators.forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                if (index + 1 < step) indicator.classList.add('completed');
                else if (index + 1 === step) indicator.classList.add('active');
            });
            
            currentStep = step;
            updateNavigationButtons();
            document.querySelector('.app-content').scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function validateStep(step) {
            let isValid = true;
            if (step === 1) {
                const nombre = document.getElementById('nombre').value.trim();
                const apellido = document.getElementById('apellido').value.trim();
                if (!nombre) { document.getElementById('nombre-error').style.display = 'block'; isValid = false; }
                if (!apellido) { document.getElementById('apellido-error').style.display = 'block'; isValid = false; }
            } 
            else if (step === 2) {
                const predico = document.querySelector('input[name="predico"]:checked');
                if (!predico) { document.getElementById('predico-error').style.display = 'block'; isValid = false; }
            }
            else if (step === 3) {
                const tipo = document.getElementById('tipo').value;
                const horas = document.getElementById('horas').value;
                
                if (!tipo) { document.getElementById('tipo-error').style.display = 'block'; isValid = false; }
                
                // VALIDACIÓN: Ahora requiere horas para Regular Y Auxiliar
                if (tipo === 'Precursor Regular' || tipo === 'Precursor Auxiliar') {
                    if (!horas || horas < 1) {
                        document.getElementById('horas-error').style.display = 'block';
                        isValid = false;
                    }
                }
            }
            return isValid;
        }
        
        function updateSummary() {
            const nombre = document.getElementById('nombre').value.trim();
            const apellido = document.getElementById('apellido').value.trim();
            const predico = document.querySelector('input[name="predico"]:checked');
            const tipo = document.getElementById('tipo').value;
            const horas = document.getElementById('horas').value;
            const estudio = document.getElementById('estudio').value;
            const observaciones = document.getElementById('observaciones').value.trim();
            
            document.getElementById('resumen-nombre').textContent = `${nombre} ${apellido}`;
            document.getElementById('resumen-predico').textContent = predico ? predico.value : '-';
            document.getElementById('resumen-tipo').textContent = tipo || '-';
            
            const horasContainer = document.getElementById('resumen-horas-container');
            // MOSTRAR RESUMEN: Para Regular Y Auxiliar
            if (tipo === 'Precursor Regular' || tipo === 'Precursor Auxiliar') {
                document.getElementById('resumen-horas').textContent = horas ? `${horas} h` : '-';
                horasContainer.style.display = 'flex';
            } else {
                horasContainer.style.display = 'none';
            }
            
            document.getElementById('resumen-estudio').textContent = estudio || '0';
            document.getElementById('resumen-observaciones').textContent = observaciones || 'Ninguna';
        }
        
        nextBtn.addEventListener('click', () => {
            if (currentStep === totalSteps - 1) updateSummary();
            goToStep(currentStep + 1);
        });
        
        prevBtn.addEventListener('click', () => goToStep(currentStep - 1));
        
        submitBtn.addEventListener('click', async function() {
            const originalContent = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            this.disabled = true;
            this.style.opacity = '0.7';

            const formData = {
                nombre: document.getElementById('nombre').value.trim(),
                apellido: document.getElementById('apellido').value.trim(),
                predico: document.querySelector('input[name="predico"]:checked').value,
                tipo: document.getElementById('tipo').value,
                horas: document.getElementById('horas').value ? parseInt(document.getElementById('horas').value) : 0,
                estudios: document.getElementById('estudio').value ? parseInt(document.getElementById('estudio').value) : 0,
                observaciones: document.getElementById('observaciones').value.trim()
            };
            
            try {
                const { error } = await supabaseClient.from('informes').insert([formData]);
                if (error) throw error;
                successModal.classList.add('active');
            } catch (error) {
                console.error('Error:', error.message);
                alert('Hubo un error al enviar el informe. Por favor revise su conexión e intente nuevamente.');
            } finally {
                this.innerHTML = originalContent;
                this.disabled = false;
                this.style.opacity = '1';
            }
        });
        
        modalCloseBtn.addEventListener('click', function() {
            successModal.classList.remove('active');
            setTimeout(() => {
                // Reset Form
                document.getElementById('nombre').value = '';
                document.getElementById('apellido').value = '';
                document.querySelectorAll('input[name="predico"]').forEach(r => r.checked = false);
                document.querySelectorAll('.radio-option').forEach(el => el.classList.remove('selected'));
                document.getElementById('tipo').value = '';
                document.getElementById('horas').value = '';
                document.getElementById('estudio').value = '';
                document.getElementById('observaciones').value = '';
                document.getElementById('hours-container').classList.remove('active');
                goToStep(1);
            }, 300);
        });
        
        // EVENT LISTENER CRÍTICO: Mostrar horas para ambos precursores
        document.getElementById('tipo').addEventListener('change', function() {
            const hoursContainer = document.getElementById('hours-container');
            const showHours = (this.value === 'Precursor Regular' || this.value === 'Precursor Auxiliar');
            
            if (showHours) {
                hoursContainer.classList.add('active');
                setTimeout(() => document.getElementById('horas').focus(), 100);
            } else {
                hoursContainer.classList.remove('active');
                document.getElementById('horas').value = ''; // Limpiar si cambia a publicador
            }
            document.getElementById('tipo-error').style.display = 'none';
        });

        ['nombre', 'apellido', 'horas'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                if(this.value.trim()) document.getElementById(id + '-error').style.display = 'none';
            });
        });

        updateNavigationButtons();
    </script>
</body>
</html>
